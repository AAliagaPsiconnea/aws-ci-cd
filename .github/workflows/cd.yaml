name: CD Pipeline
on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - id: whoami
        run: |
          ACCOUNT=$(aws sts get-caller-identity --query Account --output text)
          echo "account=$ACCOUNT" >> "$GITHUB_OUTPUT"

      - id: registry
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
          ACCOUNT: ${{ steps.whoami.outputs.account }}
        run: |
          REGISTRY="${ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          echo "value=$REGISTRY" >> "$GITHUB_OUTPUT"

      - id: extract-release-tag
        run: |
          TAG=$(git log -1 --pretty=%B | grep -oE 'release/[0-9A-Za-z.\-]+' | cut -d/ -f2)
          if [[ -z "$TAG" ]]; then
            echo "âŒ Could not extract release tag"
            exit 1
          fi
          echo "aws_tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Using release tag: $TAG"

      - name: Get latest task definition JSON
        run: |
          aws ecs describe-task-definition \
            --task-definition ${{ secrets.ECS_TASK_DEFINITION }} \
            --query taskDefinition \
            --output json \
            | jq 'del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)' \
            > task-def.json

      - name: Fetch secrets from SSM Parameter Store
        run: |
          SERVICE_NAME="${{ secrets.PARAMETER_STORE_PATH }}"

          PARAMS=$(aws ssm get-parameters-by-path \
            --path "/emotinet/pro/$SERVICE_NAME/" \
            --with-decryption \
            --recursive \
            --query "Parameters[].{Name:Name}" \
            --output json)

          echo "Fetched $(echo $PARAMS | jq length) parameters from SSM"

          echo "$PARAMS" \
            | jq '[.[] | {name: (.Name | split("/")[-1]), valueFrom: .Name}]' \
            > secrets.json

      - name: Inject image + secrets
        run: |
          IMAGE="${{ steps.registry.outputs.value }}/${{ secrets.ECR_REPOSITORY_NAME }}:${{ steps.extract-release-tag.outputs.aws_tag }}"
          echo "Deploying image: $IMAGE"

          jq -c . secrets.json > secrets.min.json

          jq --arg IMAGE "$IMAGE" \
            '.containerDefinitions[0].image=$IMAGE
              | .containerDefinitions[0].secrets=input' \
            task-def.json secrets.min.json > new-task-def.json

          echo "Final task definition:"
          cat new-task-def.json | jq .

      - name: Register new task definition revision
        run: |
          NEW_REVISION=$(aws ecs register-task-definition \
            --cli-input-json file://new-task-def.json \
            --query taskDefinition.taskDefinitionArn \
            --output text)
          echo "new_revision=$NEW_REVISION" >> $GITHUB_ENV
          echo "Registered $NEW_REVISION"

      - name: Deploy new revision to ECS service
        run: |
          aws ecs update-service \
            --cluster ${{ secrets.ECS_CLUSTER_NAME }} \
            --service ${{ secrets.ECS_SERVICE_NAME }} \
            --task-definition "$new_revision" \
            --force-new-deployment \
            --region ${{ secrets.AWS_REGION }}
